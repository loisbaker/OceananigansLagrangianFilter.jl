<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Shallow water inertial oscillation offline · OceananigansLagrangianFilter.jl</title><meta name="title" content="Shallow water inertial oscillation offline · OceananigansLagrangianFilter.jl"/><meta property="og:title" content="Shallow water inertial oscillation offline · OceananigansLagrangianFilter.jl"/><meta property="twitter:title" content="Shallow water inertial oscillation offline · OceananigansLagrangianFilter.jl"/><meta name="description" content="Documentation for OceananigansLagrangianFilter.jl."/><meta property="og:description" content="Documentation for OceananigansLagrangianFilter.jl."/><meta property="twitter:description" content="Documentation for OceananigansLagrangianFilter.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">OceananigansLagrangianFilter.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../installation/">Installation</a></li><li><a class="tocitem" href="../../quick_start/">Quick start</a></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">Theory</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../theory/Eulerian_Lagrangian_definitions/">Eulerian and Lagrangian averaging</a></li><li><a class="tocitem" href="../../theory/filtering_PDEs/">Background: PDEs for Lagrangian filtering</a></li><li><a class="tocitem" href="../../theory/online_equations/">Online Lagrangian filtering equations</a></li><li><a class="tocitem" href="../../theory/offline_equations/">Offline Lagrangian filtering equations</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">Online filtering</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../online_filtering/online_implementation/">Online filtering implementation</a></li><li><a class="tocitem" href="../../online_filtering/choosing_online_filters/">Choosing online filters</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">Offline filtering</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../offline_filtering/offline_implementation/">Offline filtering implementation</a></li><li><a class="tocitem" href="../../offline_filtering/choosing_offline_filters/">Choosing offline filters</a></li><li><a class="tocitem" href="../../offline_filtering/offline_how_it_works/">How it works</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox" checked/><label class="tocitem" for="menuitem-7"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../online_filter_geostrophic_adjustment/">Geostrophic adjustment online</a></li><li><a class="tocitem" href="../offline_filter_geostrophic_adjustment/">Geostrophic adjustment offline</a></li><li class="is-active"><a class="tocitem" href>Shallow water inertial oscillation offline</a><ul class="internal"><li><a class="tocitem" href="#Run-the-simulation"><span>Run the simulation</span></a></li><li><a class="tocitem" href="#Perform-Lagrangian-filtering"><span>Perform Lagrangian filtering</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li><li><a class="tocitem" href="../../library/">Library</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Shallow water inertial oscillation offline</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Shallow water inertial oscillation offline</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://loisbaker.github.io/OceananigansLagrangianFilter.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Shallow-water-intertial-oscillations-with-offline-Lagrangian-filtering"><a class="docs-heading-anchor" href="#Shallow-water-intertial-oscillations-with-offline-Lagrangian-filtering">Shallow water intertial oscillations with offline Lagrangian filtering</a><a id="Shallow-water-intertial-oscillations-with-offline-Lagrangian-filtering-1"></a><a class="docs-heading-anchor-permalink" href="#Shallow-water-intertial-oscillations-with-offline-Lagrangian-filtering" title="Permalink"></a></h1><p>This example demonstrates how to perform offline filtering on a shallow water simulation to remove the effect of inertial oscillations on a tracer field.</p><p>We could also filter a shallow water simulation online, but would have to use the <span>$VectorInvariantFormulation$</span> in order to have direct access to the model velocities. This example uses the <span>$ConservativeFormulation$</span> instead, and filtering is performed offline using the saved velocities after they have been calculated from <span>$uh$</span> and <span>$vh$</span>.</p><h2 id="Run-the-simulation"><a class="docs-heading-anchor" href="#Run-the-simulation">Run the simulation</a><a id="Run-the-simulation-1"></a><a class="docs-heading-anchor-permalink" href="#Run-the-simulation" title="Permalink"></a></h2><h3 id="Install-dependencies"><a class="docs-heading-anchor" href="#Install-dependencies">Install dependencies</a><a id="Install-dependencies-1"></a><a class="docs-heading-anchor-permalink" href="#Install-dependencies" title="Permalink"></a></h3><pre><code class="language-julia hljs">using Oceananigans
using Printf
using NCDatasets

filename_stem = &quot;SW_IO_with_tracer&quot;;</code></pre><h3 id="Define-the-grid"><a class="docs-heading-anchor" href="#Define-the-grid">Define the grid</a><a id="Define-the-grid-1"></a><a class="docs-heading-anchor-permalink" href="#Define-the-grid" title="Permalink"></a></h3><pre><code class="language-julia hljs">grid = RectilinearGrid(CPU(), size = (50, 50),
                       x = (0, 2*pi),
                       y = (0, 2*pi),
                       topology = (Periodic, Periodic, Flat))</code></pre><pre><code class="nohighlight hljs">50×50×1 RectilinearGrid{Float64, Periodic, Periodic, Flat} on CPU with 3×3×0 halo
├── Periodic x ∈ [4.03717e-17, 6.28319) regularly spaced with Δx=0.125664
├── Periodic y ∈ [4.03717e-17, 6.28319) regularly spaced with Δy=0.125664
└── Flat z                              </code></pre><h3 id="Set-parameters"><a class="docs-heading-anchor" href="#Set-parameters">Set parameters</a><a id="Set-parameters-1"></a><a class="docs-heading-anchor-permalink" href="#Set-parameters" title="Permalink"></a></h3><p>Building a <code>ShallowWaterModel</code>. We non-dimensionalise as in Kafiabad &amp; Vanneste 2023.</p><pre><code class="language-julia hljs">Fr = 0.1 # Froude number
Ro = 1 # fRossby number

gravitational_acceleration = 1/Fr^2
coriolis = FPlane(f=1/Ro)</code></pre><pre><code class="nohighlight hljs">FPlane{Float64}(f=1.0)</code></pre><h3 id="Define-the-model"><a class="docs-heading-anchor" href="#Define-the-model">Define the model</a><a id="Define-the-model-1"></a><a class="docs-heading-anchor-permalink" href="#Define-the-model" title="Permalink"></a></h3><pre><code class="language-julia hljs">model = ShallowWaterModel(; grid, coriolis, gravitational_acceleration,
                            timestepper = :RungeKutta3,
                            tracers= (:T,),
                            momentum_advection = WENO())</code></pre><pre><code class="nohighlight hljs">ShallowWaterModel{typename(CPU), Float64}(time = 0 seconds, iteration = 0) 
├── grid: 50×50×1 RectilinearGrid{Float64, Periodic, Periodic, Flat} on CPU with 3×3×0 halo
├── timestepper: RungeKutta3TimeStepper
├── advection scheme: 
│   ├── momentum: WENO{3, Float64, Float32}(order=5)
│   ├── mass: WENO{3, Float64, Float32}(order=5)
│   └── T: WENO{3, Float64, Float32}(order=5)
├── tracers: (:T,)
└── coriolis: FPlane{Float64}</code></pre><h3 id="Initial-conditions"><a class="docs-heading-anchor" href="#Initial-conditions">Initial conditions</a><a id="Initial-conditions-1"></a><a class="docs-heading-anchor-permalink" href="#Initial-conditions" title="Permalink"></a></h3><p>Velocity and height initial conditions - uniform velocity perturbation, initial height is 1 (unperturbed)</p><pre><code class="language-julia hljs">displacement = 2*pi/10
u_i = displacement/Ro
h_i = 1
uh_i = u_i*h_i;</code></pre><p>Initialise a tracer as a blob in the middle of the domain</p><pre><code class="language-julia hljs">width = 2*pi/15
T_i(x, y) = exp(-(((x - pi)^2 + (y - pi)^2)/width).^2)

set!(model, uh = uh_i, h= h_i, T = T_i )

uh, vh, h = model.solution

u = Field(uh / h)
v = Field(vh / h)
T = model.tracers.T</code></pre><pre><code class="nohighlight hljs">50×50×1 Field{Center, Center, Center} on RectilinearGrid on CPU
├── grid: 50×50×1 RectilinearGrid{Float64, Periodic, Periodic, Flat} on CPU with 3×3×0 halo
├── boundary conditions: FieldBoundaryConditions
│   └── west: Periodic, east: Periodic, south: Periodic, north: Periodic, bottom: Nothing, top: Nothing, immersed: Nothing
└── data: 56×56×1 OffsetArray(::Array{Float64, 3}, -2:53, -2:53, 1:1) with eltype Float64 with indices -2:53×-2:53×1:1
    └── max=0.999645, min=0.0, mean=0.0295409</code></pre><h3 id="Simulation"><a class="docs-heading-anchor" href="#Simulation">Simulation</a><a id="Simulation-1"></a><a class="docs-heading-anchor-permalink" href="#Simulation" title="Permalink"></a></h3><pre><code class="language-julia hljs">simulation = Simulation(model, Δt = 1e-2, stop_time = 20)

function progress(sim)
    model = sim.model
    uh, vh, h = model.solution
    @info @sprintf(&quot;Simulation time: %s, max(|uh|, |vh|, |h|): %.2e, %.2e, %.2e \n&quot;,
                   prettytime(sim.model.clock.time),
                   maximum(abs, uh), maximum(abs, vh),
                   maximum(abs, h))

    return nothing
end

simulation.callbacks[:progress] = Callback(progress, IterationInterval(100))</code></pre><pre><code class="nohighlight hljs">Callback of progress on IterationInterval(100)</code></pre><h3 id="Set-up-the-outputs"><a class="docs-heading-anchor" href="#Set-up-the-outputs">Set up the outputs</a><a id="Set-up-the-outputs-1"></a><a class="docs-heading-anchor-permalink" href="#Set-up-the-outputs" title="Permalink"></a></h3><p>Save velocities and tracer for Lagrangian filtering</p><pre><code class="language-julia hljs">simulation.output_writers[:fields_jld2] = JLD2Writer(model, (; u,v,T),
                                                        filename = filename_stem * &quot;.jld2&quot;,
                                                        schedule = TimeInterval(0.1),
                                                        overwrite_existing = true)</code></pre><pre><code class="nohighlight hljs">JLD2Writer scheduled on TimeInterval(100 ms):
├── filepath: SW_IO_with_tracer.jld2
├── 3 outputs: (u, v, T)
├── array_type: Array{Float32}
├── including: [:grid, :coriolis, :closure]
├── file_splitting: NoFileSplitting
└── file size: 30.2 KiB</code></pre><h3 id="And-finally-run-the-simulation."><a class="docs-heading-anchor" href="#And-finally-run-the-simulation.">And finally run the simulation.</a><a id="And-finally-run-the-simulation.-1"></a><a class="docs-heading-anchor-permalink" href="#And-finally-run-the-simulation." title="Permalink"></a></h3><pre><code class="language-julia hljs">run!(simulation)</code></pre><pre><code class="nohighlight hljs">[ Info: Initializing simulation...
[ Info: Simulation time: 0 seconds, max(|uh|, |vh|, |h|): 6.28e-01, 0.00e+00, 1.00e+00 
[ Info:     ... simulation initialization complete (6.819 seconds)
[ Info: Executing initial time step...
[ Info:     ... initial time step complete (5.233 seconds).
[ Info: Simulation time: 930.000 ms, max(|uh|, |vh|, |h|): 3.76e-01, 5.04e-01, 1.00e+00 
[ Info: Simulation time: 1.890 seconds, max(|uh|, |vh|, |h|): 1.97e-01, 5.97e-01, 1.00e+00 
[ Info: Simulation time: 2.800 seconds, max(|uh|, |vh|, |h|): 5.92e-01, 2.10e-01, 1.00e+00 
[ Info: Simulation time: 3.710 seconds, max(|uh|, |vh|, |h|): 5.30e-01, 3.38e-01, 1.00e+00 
[ Info: Simulation time: 4.620 seconds, max(|uh|, |vh|, |h|): 5.80e-02, 6.26e-01, 1.00e+00 
[ Info: Simulation time: 5.530 seconds, max(|uh|, |vh|, |h|): 4.58e-01, 4.30e-01, 1.00e+00 
[ Info: Simulation time: 6.440 seconds, max(|uh|, |vh|, |h|): 6.21e-01, 9.81e-02, 1.00e+00 
[ Info: Simulation time: 7.350 seconds, max(|uh|, |vh|, |h|): 3.03e-01, 5.50e-01, 1.00e+00 
[ Info: Simulation time: 8.260 seconds, max(|uh|, |vh|, |h|): 2.48e-01, 5.77e-01, 1.00e+00 
[ Info: Simulation time: 9.170 seconds, max(|uh|, |vh|, |h|): 6.08e-01, 1.58e-01, 1.00e+00 
[ Info: Simulation time: 10.080 seconds, max(|uh|, |vh|, |h|): 4.98e-01, 3.83e-01, 1.00e+00 
[ Info: Simulation time: 10.990 seconds, max(|uh|, |vh|, |h|): 3.50e-03, 6.28e-01, 1.00e+00 
[ Info: Simulation time: 11.900 seconds, max(|uh|, |vh|, |h|): 4.94e-01, 3.88e-01, 1.00e+00 
[ Info: Simulation time: 12.800 seconds, max(|uh|, |vh|, |h|): 6.11e-01, 1.45e-01, 1.00e+00 
[ Info: Simulation time: 13.710 seconds, max(|uh|, |vh|, |h|): 2.60e-01, 5.72e-01, 1.00e+00 
[ Info: Simulation time: 14.620 seconds, max(|uh|, |vh|, |h|): 2.92e-01, 5.56e-01, 1.00e+00 
[ Info: Simulation time: 15.530 seconds, max(|uh|, |vh|, |h|): 6.18e-01, 1.11e-01, 1.00e+00 
[ Info: Simulation time: 16.480 seconds, max(|uh|, |vh|, |h|): 4.50e-01, 4.38e-01, 1.00e+00 
[ Info: Simulation time: 17.480 seconds, max(|uh|, |vh|, |h|): 1.26e-01, 6.16e-01, 1.00e+00 
[ Info: Simulation time: 18.480 seconds, max(|uh|, |vh|, |h|): 5.86e-01, 2.27e-01, 1.00e+00 
[ Info: Simulation time: 19.480 seconds, max(|uh|, |vh|, |h|): 5.08e-01, 3.70e-01, 1.00e+00 
[ Info: Simulation is stopping after running for 19.298 seconds.
[ Info: Simulation time 20 seconds equals or exceeds stop time 20 seconds.
</code></pre><h2 id="Perform-Lagrangian-filtering"><a class="docs-heading-anchor" href="#Perform-Lagrangian-filtering">Perform Lagrangian filtering</a><a id="Perform-Lagrangian-filtering-1"></a><a class="docs-heading-anchor-permalink" href="#Perform-Lagrangian-filtering" title="Permalink"></a></h2><p>Now we set up and run the offline Lagrangian filter on the output of the above simulation. This could be performed in a different script (with appropriate import of Oceananigans.Units and CUDA if needed)</p><pre><code class="language-julia hljs">using OceananigansLagrangianFilter</code></pre><h3 id="Set-up-the-filter-configuration"><a class="docs-heading-anchor" href="#Set-up-the-filter-configuration">Set up the filter configuration</a><a id="Set-up-the-filter-configuration-1"></a><a class="docs-heading-anchor-permalink" href="#Set-up-the-filter-configuration" title="Permalink"></a></h3><pre><code class="language-julia hljs">filter_config = OfflineFilterConfig(original_data_filename=&quot;SW_IO_with_tracer.jld2&quot;, # Where the original simulation output is
                                    output_filename = &quot;SW_IO_with_tracer_filtered.jld2&quot;, # Where to save the filtered output
                                    var_names_to_filter = (&quot;T&quot;,), # Which variables to filter
                                    velocity_names = (&quot;u&quot;,&quot;v&quot;), # Velocities to use for remapping
                                    architecture = CPU(), # CPU() or GPU(), if GPU() make sure you have CUDA.jl installed and imported
                                    Δt = 1e-2, # Time step of filtering simulation
                                    T_out=0.1, # How often to output filtered data
                                    N=2, # Order of Butterworth filter
                                    freq_c = 0.5, # Cut-off frequency of Butterworth filter
                                    compute_mean_velocities= true, # Whether to compute mean velocities
                                    output_netcdf = true, # Whether to output filtered data to a netcdf file in addition to .jld2
                                    delete_intermediate_files = true, # Delete the individual output of the forward and backward passes
                                    compute_Eulerian_filter = true) # Whether to compute the Eulerian filter for comparison</code></pre><pre><code class="nohighlight hljs">OfflineFilterConfig(&quot;SW_IO_with_tracer.jld2&quot;, (&quot;T&quot;,), (&quot;u&quot;, &quot;v&quot;), 0.0, 20.0, 20.0, CPU(), 0.1, (a1 = 0.17677669529663687, b1 = 0.1767766952966369, c1 = 0.35355339059327373, d1 = 0.3535533905932738, N_coeffs = 1), 0.01, InMemory{Int64}(1, 4), true, &quot;forward_output.jld2&quot;, &quot;backward_output.jld2&quot;, &quot;SW_IO_with_tracer_filtered.jld2&quot;, 5, true, true, true, true, true, WENO{3, Float64, Float32}(order=5)
├── buffer_scheme: WENO{2, Float64, Float32}(order=3)
└── advection_velocity_scheme: Centered(order=4), 50×50×1 RectilinearGrid{Float64, Periodic, Periodic, Flat} on CPU with 3×3×0 halo
├── Periodic x ∈ [4.03717e-17, 6.28319) regularly spaced with Δx=0.125664
├── Periodic y ∈ [4.03717e-17, 6.28319) regularly spaced with Δy=0.125664
└── Flat z                              , &quot;offline&quot;)</code></pre><h3 id="Run-the-offline-Lagrangian-filter"><a class="docs-heading-anchor" href="#Run-the-offline-Lagrangian-filter">Run the offline Lagrangian filter</a><a id="Run-the-offline-Lagrangian-filter-1"></a><a class="docs-heading-anchor-permalink" href="#Run-the-offline-Lagrangian-filter" title="Permalink"></a></h3><pre><code class="language-julia hljs">run_offline_Lagrangian_filter(filter_config)</code></pre><pre><code class="nohighlight hljs">[ Info: Loaded data from SW_IO_with_tracer.jld2
[ Info: Created original variables: (:T,)
[ Info: Created filtered variables: (:T_C1, :xi_u_C1, :xi_v_C1, :T_S1, :xi_u_S1, :xi_v_S1)
[ Info: Created forcing for filtered variables
[ Info: Created model
[ Info: Initialised filtered variables
[ Info: Defined outputs
[ Info: Defined simulation
[ Info: Initializing simulation...
[ Info: Simulation time: 0 seconds
[ Info:     ... simulation initialization complete (21.609 seconds)
[ Info: Executing initial time step...
[ Info:     ... initial time step complete (12.977 seconds).
[ Info: Simulation time: 2 seconds
[ Info: Simulation time: 4 seconds
[ Info: Simulation time: 6 seconds
[ Info: Simulation time: 8 seconds
[ Info: Simulation time: 10 seconds
[ Info: Simulation time: 12 seconds
[ Info: Simulation time: 14 seconds
[ Info: Simulation time: 16 seconds
[ Info: Simulation time: 18 seconds
[ Info: Simulation is stopping after running for 7.382 minutes.
[ Info: Simulation time 20 seconds equals or exceeds stop time 20 seconds.
[ Info: Simulation time: 20 seconds
[ Info: Initializing simulation...
[ Info: Simulation time: 0 seconds
[ Info:     ... simulation initialization complete (75.930 ms)
[ Info: Executing initial time step...
[ Info:     ... initial time step complete (249.347 ms).
[ Info: Simulation time: 2 seconds
[ Info: Simulation time: 4 seconds
[ Info: Simulation time: 6 seconds
[ Info: Simulation time: 8 seconds
[ Info: Simulation time: 10 seconds
[ Info: Simulation time: 12 seconds
[ Info: Simulation time: 14 seconds
[ Info: Simulation time: 16 seconds
[ Info: Simulation time: 18 seconds
[ Info: Simulation is stopping after running for 6.286 minutes.
[ Info: Simulation time 20 seconds equals or exceeds stop time 20 seconds.
[ Info: Simulation time: 20 seconds
[ Info: Combined forward and backward contributions into SW_IO_with_tracer_filtered.jld2
[ Info: Wrote regridded data to new variables with _at_mean suffix in file SW_IO_with_tracer_filtered.jld2
[ Info: Computing Eulerian filter for variable T
[ Info: Computing Eulerian filter for variable u
[ Info: Computing Eulerian filter for variable v
[ Info: Wrote NetCDF file to SW_IO_with_tracer_filtered.nc
</code></pre><h3 id="Visualisation"><a class="docs-heading-anchor" href="#Visualisation">Visualisation</a><a id="Visualisation-1"></a><a class="docs-heading-anchor-permalink" href="#Visualisation" title="Permalink"></a></h3><pre><code class="language-julia hljs">using CairoMakie</code></pre><p>Now we animate the results.</p><pre><code class="language-julia hljs">timeseries1 = FieldTimeSeries(filter_config.output_filename, &quot;T&quot;)
timeseries2 = FieldTimeSeries(filter_config.output_filename, &quot;T_Eulerian_filtered&quot;)
timeseries3 = FieldTimeSeries(filter_config.output_filename, &quot;T_Lagrangian_filtered&quot;)
timeseries4 = FieldTimeSeries(filter_config.output_filename, &quot;T_Lagrangian_filtered_at_mean&quot;)

times = timeseries1.times

set_theme!(Theme(fontsize = 20))
fig = Figure(size = (1300, 500))

axis_kwargs = (xlabel = &quot;x&quot;,
               ylabel = &quot;y&quot;,
               limits = ((0, 2*pi), (0, 2*pi)),
               aspect = AxisAspect(1))

ax1 = Axis(fig[2, 1]; title = &quot;Raw&quot;, axis_kwargs...)
ax2 = Axis(fig[2, 2]; title = &quot;Eulerian filtered&quot;, axis_kwargs...)
ax3 = Axis(fig[2, 3]; title = &quot;Lagrangian filtered&quot;, axis_kwargs...)
ax4 = Axis(fig[2, 4]; title = &quot;Lagrangian filtered at mean&quot;, axis_kwargs...)


n = Observable(1)
Observable(1)

var1 = @lift timeseries1[$n]
var2 = @lift timeseries2[$n]
var3 = @lift timeseries3[$n]
var4 = @lift timeseries4[$n]

heatmap!(ax1, var1; colormap = :Spectral, colorrange = (0, 1))
heatmap!(ax2, var2; colormap = :Spectral, colorrange = (0, 1))
heatmap!(ax3, var3; colormap = :Spectral, colorrange = (0, 1))
heatmap!(ax4, var4; colormap = :Spectral, colorrange = (0, 1))


title = @lift &quot;Tracer T at time = &quot; * string(round(times[$n], digits=2))
Label(fig[1, 1:4], title, fontsize=24, tellwidth=false)

fig

frames = 1:length(times)

@info &quot;Making an animation&quot;

CairoMakie.record(fig, &quot;IO_filtered_tracer_movie_offline.mp4&quot;, frames, framerate=24) do i
    n[] = i
end</code></pre><pre><code class="nohighlight hljs">&quot;IO_filtered_tracer_movie_offline.mp4&quot;</code></pre><p><video src="../IO_filtered_tracer_movie_offline.mp4" controls="true" title><a href="../IO_filtered_tracer_movie_offline.mp4"></a></video></p><p>We see that the Eulerian filter smudges the tracer field as it is advected by the inertial oscillations. The Lagrangian means directly calculated by this method are identical to the raw fields for the tracer and buoyancy shown, as they are conservative fields. However, when we remap to a mean reference position, we see the value of the Lagrangian filter in effectively removing the oscillations while preserving the tracer structures.</p><pre><code class="language-julia hljs"># We remove these files to keep things tidy, keep them for analysis if desired
rm(filename_stem * &quot;.jld2&quot;)
rm(filter_config.output_filename)
rm(filter_config.output_filename[1:end-5] * &quot;.nc&quot;)</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../offline_filter_geostrophic_adjustment/">« Geostrophic adjustment offline</a><a class="docs-footer-nextpage" href="../../references/">References »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.15.0 on <span class="colophon-date" title="Monday 27 October 2025 17:17">Monday 27 October 2025</span>. Using Julia version 1.10.10.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
