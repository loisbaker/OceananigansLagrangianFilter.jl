<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Geostrophic adjustment offline · OceananigansLagrangianFilter.jl</title><meta name="title" content="Geostrophic adjustment offline · OceananigansLagrangianFilter.jl"/><meta property="og:title" content="Geostrophic adjustment offline · OceananigansLagrangianFilter.jl"/><meta property="twitter:title" content="Geostrophic adjustment offline · OceananigansLagrangianFilter.jl"/><meta name="description" content="Documentation for OceananigansLagrangianFilter.jl."/><meta property="og:description" content="Documentation for OceananigansLagrangianFilter.jl."/><meta property="twitter:description" content="Documentation for OceananigansLagrangianFilter.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">OceananigansLagrangianFilter.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../installation/">Installation</a></li><li><a class="tocitem" href="../../quick_start/">Quick start</a></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">Theory</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../theory/Eulerian_Lagrangian_definitions/">Eulerian and Lagrangian averaging</a></li><li><a class="tocitem" href="../../theory/filtering_PDEs/">Background: PDEs for Lagrangian filtering</a></li><li><a class="tocitem" href="../../theory/online_equations/">Online Lagrangian filtering equations</a></li><li><a class="tocitem" href="../../theory/offline_equations/">Offline Lagrangian filtering equations</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">Online filtering</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../online_filtering/online_implementation/">Online filtering implementation</a></li><li><a class="tocitem" href="../../online_filtering/choosing_online_filters/">Choosing online filters</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">Offline filtering</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../offline_filtering/offline_implementation/">Offline filtering implementation</a></li><li><a class="tocitem" href="../../offline_filtering/choosing_offline_filters/">Choosing offline filters</a></li><li><a class="tocitem" href="../../offline_filtering/offline_how_it_works/">How it works</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox" checked/><label class="tocitem" for="menuitem-7"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../online_filter_geostrophic_adjustment/">Geostrophic adjustment online</a></li><li class="is-active"><a class="tocitem" href>Geostrophic adjustment offline</a><ul class="internal"><li><a class="tocitem" href="#Run-the-simulation"><span>Run the simulation</span></a></li><li><a class="tocitem" href="#Perform-Lagrangian-filtering"><span>Perform Lagrangian filtering</span></a></li></ul></li><li><a class="tocitem" href="../offline_filter_shallow_water_IO/">Shallow water inertial oscillation offline</a></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li><li><a class="tocitem" href="../../library/">Library</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Geostrophic adjustment offline</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Geostrophic adjustment offline</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://loisbaker.github.io/OceananigansLagrangianFilter.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Geostrophic-adjustment-with-offline-Lagrangian-filtering"><a class="docs-heading-anchor" href="#Geostrophic-adjustment-with-offline-Lagrangian-filtering">Geostrophic adjustment with offline Lagrangian filtering</a><a id="Geostrophic-adjustment-with-offline-Lagrangian-filtering-1"></a><a class="docs-heading-anchor-permalink" href="#Geostrophic-adjustment-with-offline-Lagrangian-filtering" title="Permalink"></a></h1><p>We set up a geostrophic adjustment problem similar to Blumen (2000), JPO in a domain that is horizontally periodic.</p><p>An initially unbalanced two-dimensional front oscillates with the inertial frequency around a state of geostrophic balance, and we illustrate that we can remove the oscillations to find the mean state. Credit to Tom Cummings for work on this example.</p><p>In this example, the filtering is performed offline after the simulation.</p><h2 id="Run-the-simulation"><a class="docs-heading-anchor" href="#Run-the-simulation">Run the simulation</a><a id="Run-the-simulation-1"></a><a class="docs-heading-anchor-permalink" href="#Run-the-simulation" title="Permalink"></a></h2><h3 id="Install-dependencies"><a class="docs-heading-anchor" href="#Install-dependencies">Install dependencies</a><a id="Install-dependencies-1"></a><a class="docs-heading-anchor-permalink" href="#Install-dependencies" title="Permalink"></a></h3><pre><code class="language-julia hljs">using Oceananigans
using Oceananigans.Units
using NCDatasets
using Printf</code></pre><h3 id="Model-parameters"><a class="docs-heading-anchor" href="#Model-parameters">Model parameters</a><a id="Model-parameters-1"></a><a class="docs-heading-anchor-permalink" href="#Model-parameters" title="Permalink"></a></h3><pre><code class="language-julia hljs">Nx = 400
Nz = 80
f = 1e-4                # Coriolis frequency [s⁻¹]
L_front = 10kilometers  # Initial front width [m]
aspect_ratio = 100      # L_front/H
Ro = 0.1                # Rossby number (defines M^2)

H = L_front/aspect_ratio  # Depth
M² = (Ro^2*f^2*L_front)/H # Horizontal buoyancy gradient
Δb = M²*L_front # Buoyancy difference across the front
κh = 1e-6 # Horizontal diffusivity
κv = 1e-6 # Vertical diffusivity

filename_stem = &quot;geostrophic_adjustment&quot;;</code></pre><h3 id="Define-the-grid"><a class="docs-heading-anchor" href="#Define-the-grid">Define the grid</a><a id="Define-the-grid-1"></a><a class="docs-heading-anchor-permalink" href="#Define-the-grid" title="Permalink"></a></h3><pre><code class="language-julia hljs">grid = RectilinearGrid(CPU(),size = (Nx, Nz),
                       x = (-L_front/2, L_front/2),
                       z = (-H, 0),
                       topology = (Periodic, Flat, Bounded))</code></pre><pre><code class="nohighlight hljs">400×1×80 RectilinearGrid{Float64, Periodic, Flat, Bounded} on CPU with 3×0×3 halo
├── Periodic x ∈ [-5000.0, 5000.0) regularly spaced with Δx=25.0
├── Flat y                         
└── Bounded  z ∈ [-100.0, 0.0]     regularly spaced with Δz=1.25</code></pre><h3 id="Closures"><a class="docs-heading-anchor" href="#Closures">Closures</a><a id="Closures-1"></a><a class="docs-heading-anchor-permalink" href="#Closures" title="Permalink"></a></h3><pre><code class="language-julia hljs">horizontal_closure = HorizontalScalarDiffusivity(ν=κh, κ=κh )
vertical_closure = VerticalScalarDiffusivity(ν=κv , κ=κv )
closure = (horizontal_closure, vertical_closure);</code></pre><h3 id="Tracers"><a class="docs-heading-anchor" href="#Tracers">Tracers</a><a id="Tracers-1"></a><a class="docs-heading-anchor-permalink" href="#Tracers" title="Permalink"></a></h3><pre><code class="language-julia hljs">tracers = (:b,:T)</code></pre><pre><code class="nohighlight hljs">(:b, :T)</code></pre><h3 id="Define-the-model"><a class="docs-heading-anchor" href="#Define-the-model">Define the model</a><a id="Define-the-model-1"></a><a class="docs-heading-anchor-permalink" href="#Define-the-model" title="Permalink"></a></h3><pre><code class="language-julia hljs">model =  NonhydrostaticModel(; grid,
                coriolis = FPlane(f = f),
                buoyancy = BuoyancyTracer(),
                tracers = tracers,
                advection = WENO(),
                closure = closure)</code></pre><pre><code class="nohighlight hljs">NonhydrostaticModel{CPU, RectilinearGrid}(time = 0 seconds, iteration = 0)
├── grid: 400×1×80 RectilinearGrid{Float64, Periodic, Flat, Bounded} on CPU with 3×0×3 halo
├── timestepper: RungeKutta3TimeStepper
├── advection scheme: WENO{3, Float64, Float32}(order=5)
├── tracers: (b, T)
├── closure: Tuple with 2 closures:
│   ├── HorizontalScalarDiffusivity{ExplicitTimeDiscretization}(ν=1.0e-6, κ=(b=1.0e-6, T=1.0e-6))
│   └── VerticalScalarDiffusivity{ExplicitTimeDiscretization}(ν=1.0e-6, κ=(b=1.0e-6, T=1.0e-6))
├── buoyancy: BuoyancyTracer with ĝ = NegativeZDirection()
└── coriolis: FPlane{Float64}(f=0.0001)</code></pre><h3 id="Initialise-the-buoyancy-and-tracer"><a class="docs-heading-anchor" href="#Initialise-the-buoyancy-and-tracer">Initialise the buoyancy and tracer</a><a id="Initialise-the-buoyancy-and-tracer-1"></a><a class="docs-heading-anchor-permalink" href="#Initialise-the-buoyancy-and-tracer" title="Permalink"></a></h3><pre><code class="language-julia hljs">bᵢ(x, z) = Δb*sin(2*pi/L_front * x)
Tᵢ(x, z) = exp(-(x/(L_front/50)).^2)
set!(model, b= bᵢ, T= Tᵢ)</code></pre><h3 id="Define-the-simulation"><a class="docs-heading-anchor" href="#Define-the-simulation">Define the simulation</a><a id="Define-the-simulation-1"></a><a class="docs-heading-anchor-permalink" href="#Define-the-simulation" title="Permalink"></a></h3><pre><code class="language-julia hljs">simulation = Simulation(model, Δt=20minutes, stop_time=3days)</code></pre><pre><code class="nohighlight hljs">Simulation of NonhydrostaticModel{CPU, RectilinearGrid}(time = 0 seconds, iteration = 0)
├── Next time step: 20 minutes
├── Elapsed wall time: 0 seconds
├── Wall time per iteration: NaN days
├── Stop time: 3 days
├── Stop iteration: Inf
├── Wall time limit: Inf
├── Minimum relative step: 0.0
├── Callbacks: OrderedDict with 4 entries:
│   ├── stop_time_exceeded =&gt; 4
│   ├── stop_iteration_exceeded =&gt; -
│   ├── wall_time_limit_exceeded =&gt; e
│   └── nan_checker =&gt; }
├── Output writers: OrderedDict with no entries
└── Diagnostics: OrderedDict with no entries</code></pre><p>Set an adaptive timestep</p><pre><code class="language-julia hljs">conjure_time_step_wizard!(simulation, IterationInterval(20), cfl=0.2, max_Δt=20minutes)</code></pre><p>Add a progress callback</p><pre><code class="language-julia hljs">wall_clock = Ref(time_ns())

function print_progress(sim)
    u, v, w = model.velocities
    progress = 100 * (time(sim) / sim.stop_time)
    elapsed = (time_ns() - wall_clock[]) / 1e9

    @printf(&quot;[%05.2f%%] i: %d, t: %s, wall time: %s, max(u): (%6.3e, %6.3e, %6.3e) m/s, next Δt: %s\n&quot;,
            progress, iteration(sim), prettytime(sim), prettytime(elapsed),
            maximum(abs, u), maximum(abs, v), maximum(abs, w), prettytime(sim.Δt))

    wall_clock[] = time_ns()

    return nothing
end

add_callback!(simulation, print_progress, IterationInterval(50))</code></pre><h3 id="Set-up-the-output"><a class="docs-heading-anchor" href="#Set-up-the-output">Set up the output</a><a id="Set-up-the-output-1"></a><a class="docs-heading-anchor-permalink" href="#Set-up-the-output" title="Permalink"></a></h3><pre><code class="language-julia hljs">u, v, w = model.velocities
b = model.tracers.b
T = model.tracers.T</code></pre><pre><code class="nohighlight hljs">400×1×80 Field{Center, Center, Center} on RectilinearGrid on CPU
├── grid: 400×1×80 RectilinearGrid{Float64, Periodic, Flat, Bounded} on CPU with 3×0×3 halo
├── boundary conditions: FieldBoundaryConditions
│   └── west: Periodic, east: Periodic, south: Nothing, north: Nothing, bottom: ZeroFlux, top: ZeroFlux, immersed: Nothing
└── data: 406×1×86 OffsetArray(::Array{Float64, 3}, -2:403, 1:1, -2:83) with eltype Float64 with indices -2:403×1:1×-2:83
    └── max=0.996101, min=8.34493e-271, mean=0.0354491</code></pre><p>Fields to be filtered must be specified at cell centers, so we can interpolate before output if necessary.</p><pre><code class="language-julia hljs">wc = Field(@at (Center, Center, Center) model.velocities.w)</code></pre><pre><code class="nohighlight hljs">400×1×80 Field{Center, Center, Center} on RectilinearGrid on CPU
├── grid: 400×1×80 RectilinearGrid{Float64, Periodic, Flat, Bounded} on CPU with 3×0×3 halo
├── boundary conditions: FieldBoundaryConditions
│   └── west: Periodic, east: Periodic, south: Nothing, north: Nothing, bottom: ZeroFlux, top: ZeroFlux, immersed: Nothing
├── operand: UnaryOperation at (Center, Center, Center)
├── status: time=0.0
└── data: 406×1×86 OffsetArray(::Array{Float64, 3}, -2:403, 1:1, -2:83) with eltype Float64 with indices -2:403×1:1×-2:83
    └── max=0.0, min=0.0, mean=0.0</code></pre><p>Output a jld2 file for Lagrangian filtering</p><pre><code class="language-julia hljs">simulation.output_writers[:jld2fields] = JLD2Writer(
    model, (; b, u, v, w, wc, T), filename = filename_stem * &quot;.jld2&quot;, schedule=TimeInterval(1hour), overwrite_existing=true)</code></pre><pre><code class="nohighlight hljs">JLD2Writer scheduled on TimeInterval(1 hour):
├── filepath: geostrophic_adjustment.jld2
├── 6 outputs: (b, u, v, w, wc, T)
├── array_type: Array{Float32}
├── including: [:grid, :coriolis, :buoyancy, :closure]
├── file_splitting: NoFileSplitting
└── file size: 56.2 KiB</code></pre><h3 id="Run-simulation"><a class="docs-heading-anchor" href="#Run-simulation">Run simulation</a><a id="Run-simulation-1"></a><a class="docs-heading-anchor-permalink" href="#Run-simulation" title="Permalink"></a></h3><pre><code class="language-julia hljs">@info &quot;Running the simulation...&quot;

run!(simulation)

@info &quot;Simulation completed in &quot; * prettytime(simulation.run_wall_time)</code></pre><pre><code class="nohighlight hljs">[ Info: Running the simulation...
[ Info: Initializing simulation...
[00.00%] i: 0, t: 0 seconds, wall time: 11.125 seconds, max(u): (0.000e+00, 0.000e+00, 0.000e+00) m/s, next Δt: 20 minutes
[ Info:     ... simulation initialization complete (4.683 seconds)
[ Info: Executing initial time step...
[ Info:     ... initial time step complete (2.693 seconds).
[15.28%] i: 50, t: 11 hours, wall time: 6.623 seconds, max(u): (2.202e-02, 5.270e-02, 3.914e-04) m/s, next Δt: 6.203 minutes
[19.31%] i: 100, t: 13.906 hours, wall time: 2.897 seconds, max(u): (2.976e-02, 2.367e-02, 5.020e-04) m/s, next Δt: 2.799 minutes
[22.61%] i: 150, t: 16.282 hours, wall time: 2.870 seconds, max(u): (1.443e-02, 3.788e-03, 1.988e-04) m/s, next Δt: 3.387 minutes
[26.86%] i: 200, t: 19.342 hours, wall time: 2.857 seconds, max(u): (1.883e-02, 6.605e-03, 3.550e-04) m/s, next Δt: 4.424 minutes
[30.74%] i: 250, t: 22.136 hours, wall time: 2.828 seconds, max(u): (3.056e-02, 3.361e-02, 5.440e-04) m/s, next Δt: 2.719 minutes
[34.05%] i: 300, t: 1.021 days, wall time: 2.816 seconds, max(u): (1.847e-02, 5.559e-02, 3.703e-04) m/s, next Δt: 3.396 minutes
[38.17%] i: 350, t: 1.145 days, wall time: 2.774 seconds, max(u): (1.436e-02, 5.909e-02, 2.754e-04) m/s, next Δt: 4.109 minutes
[42.29%] i: 400, t: 1.269 days, wall time: 2.798 seconds, max(u): (3.040e-02, 3.490e-02, 6.369e-04) m/s, next Δt: 2.741 minutes
[45.41%] i: 450, t: 1.362 days, wall time: 2.805 seconds, max(u): (2.389e-02, 1.206e-02, 4.217e-04) m/s, next Δt: 3.066 minutes
[49.30%] i: 500, t: 1.479 days, wall time: 2.785 seconds, max(u): (8.215e-03, 3.499e-03, 2.378e-04) m/s, next Δt: 4.080 minutes
[53.78%] i: 550, t: 1.613 days, wall time: 2.782 seconds, max(u): (2.956e-02, 2.332e-02, 6.352e-04) m/s, next Δt: 3.000 minutes
[56.94%] i: 600, t: 1.708 days, wall time: 2.782 seconds, max(u): (2.593e-02, 4.716e-02, 6.036e-04) m/s, next Δt: 3.090 minutes
[60.67%] i: 650, t: 1.820 days, wall time: 2.786 seconds, max(u): (5.640e-03, 6.133e-02, 1.907e-04) m/s, next Δt: 3.739 minutes
[65.26%] i: 700, t: 1.958 days, wall time: 2.784 seconds, max(u): (2.763e-02, 4.474e-02, 7.847e-04) m/s, next Δt: 3.016 minutes
[68.51%] i: 750, t: 2.055 days, wall time: 2.770 seconds, max(u): (2.822e-02, 2.023e-02, 7.024e-04) m/s, next Δt: 2.816 minutes
[72.10%] i: 800, t: 2.163 days, wall time: 2.784 seconds, max(u): (9.688e-03, 5.764e-03, 1.411e-04) m/s, next Δt: 3.748 minutes
[76.39%] i: 850, t: 2.292 days, wall time: 2.782 seconds, max(u): (2.331e-02, 1.106e-02, 7.186e-04) m/s, next Δt: 4.325 minutes
[80.00%] i: 900, t: 2.400 days, wall time: 2.760 seconds, max(u): (2.951e-02, 3.757e-02, 8.395e-04) m/s, next Δt: 2.823 minutes
[83.33%] i: 950, t: 2.500 days, wall time: 2.759 seconds, max(u): (1.441e-02, 5.763e-02, 6.270e-04) m/s, next Δt: 3.416 minutes
[87.69%] i: 1000, t: 2.631 days, wall time: 2.797 seconds, max(u): (1.940e-02, 5.540e-02, 7.213e-04) m/s, next Δt: 4.296 minutes
[91.63%] i: 1050, t: 2.749 days, wall time: 2.775 seconds, max(u): (3.001e-02, 2.887e-02, 1.111e-03) m/s, next Δt: 2.780 minutes
[94.88%] i: 1100, t: 2.846 days, wall time: 2.761 seconds, max(u): (1.840e-02, 7.795e-03, 4.583e-04) m/s, next Δt: 3.430 minutes
[99.00%] i: 1150, t: 2.970 days, wall time: 2.783 seconds, max(u): (1.410e-02, 8.924e-03, 7.666e-04) m/s, next Δt: 4.151 minutes
[ Info: Simulation is stopping after running for 1.206 minutes.
[ Info: Simulation time 3 days equals or exceeds stop time 3 days.
[ Info: Simulation completed in 1.207 minutes
</code></pre><h2 id="Perform-Lagrangian-filtering"><a class="docs-heading-anchor" href="#Perform-Lagrangian-filtering">Perform Lagrangian filtering</a><a id="Perform-Lagrangian-filtering-1"></a><a class="docs-heading-anchor-permalink" href="#Perform-Lagrangian-filtering" title="Permalink"></a></h2><p>Now we set up and run the offline Lagrangian filter on the output of the above simulation. This could be performed in a different script (with appropriate import of Oceananigans.Units and CUDA if needed)</p><pre><code class="language-julia hljs">using OceananigansLagrangianFilter</code></pre><h3 id="Set-up-the-filter-configuration"><a class="docs-heading-anchor" href="#Set-up-the-filter-configuration">Set up the filter configuration</a><a id="Set-up-the-filter-configuration-1"></a><a class="docs-heading-anchor-permalink" href="#Set-up-the-filter-configuration" title="Permalink"></a></h3><pre><code class="language-julia hljs">filter_config = OfflineFilterConfig(original_data_filename=&quot;geostrophic_adjustment.jld2&quot;, # Where the original simulation output is
                                    output_filename = &quot;geostrophic_adjustment_offline_filtered.jld2&quot;, # Where to save the filtered output
                                    var_names_to_filter = (&quot;T&quot;, &quot;b&quot;), # Which variables to filter
                                    velocity_names = (&quot;u&quot;,&quot;w&quot;,&quot;v&quot;), # Velocities to use for remapping
                                    architecture = CPU(), # CPU() or GPU(), if GPU() make sure you have CUDA.jl installed and imported
                                    Δt = 20minutes, # Time step of filtering simulation
                                    T_out = 1hour, # How often to output filtered data
                                    N = 2, # Order of Butterworth filter
                                    freq_c = 1e-4/2, # Cut-off frequency of Butterworth filter
                                    compute_mean_velocities = true, # Whether to compute the mean velocities
                                    output_netcdf = true, # Whether to output filtered data to a netcdf file in addition to .jld2
                                    delete_intermediate_files = true, # Delete the individual output of the forward and backward passes
                                    compute_Eulerian_filter = true) # Whether to compute the Eulerian filter for comparison</code></pre><pre><code class="nohighlight hljs">OfflineFilterConfig(&quot;geostrophic_adjustment.jld2&quot;, (&quot;T&quot;, &quot;b&quot;), (&quot;u&quot;, &quot;w&quot;, &quot;v&quot;), 0.0, 259200.0, 259200.0, CPU(), 3600.0, (a1 = 1.767766952966369e-5, b1 = 1.767766952966369e-5, c1 = 3.535533905932738e-5, d1 = 3.535533905932738e-5, N_coeffs = 1), 1200.0, InMemory{Int64}(1, 4), true, &quot;forward_output.jld2&quot;, &quot;backward_output.jld2&quot;, &quot;geostrophic_adjustment_offline_filtered.jld2&quot;, 5, true, true, true, true, true, WENO{3, Float64, Float32}(order=5)
├── buffer_scheme: WENO{2, Float64, Float32}(order=3)
└── advection_velocity_scheme: Centered(order=4), 400×1×80 RectilinearGrid{Float64, Periodic, Flat, Bounded} on CPU with 3×0×3 halo
├── Periodic x ∈ [-5000.0, 5000.0) regularly spaced with Δx=25.0
├── Flat y                         
└── Bounded  z ∈ [-100.0, 0.0]     regularly spaced with Δz=1.25, &quot;offline&quot;)</code></pre><h3 id="Run-the-offline-Lagrangian-filter"><a class="docs-heading-anchor" href="#Run-the-offline-Lagrangian-filter">Run the offline Lagrangian filter</a><a id="Run-the-offline-Lagrangian-filter-1"></a><a class="docs-heading-anchor-permalink" href="#Run-the-offline-Lagrangian-filter" title="Permalink"></a></h3><pre><code class="language-julia hljs">run_offline_Lagrangian_filter(filter_config)</code></pre><pre><code class="nohighlight hljs">[ Info: Loaded data from geostrophic_adjustment.jld2
[ Info: Created original variables: (:T, :b)
[ Info: Created filtered variables: (:T_C1, :b_C1, :xi_u_C1, :xi_w_C1, :xi_v_C1, :T_S1, :b_S1, :xi_u_S1, :xi_w_S1, :xi_v_S1)
[ Info: Created forcing for filtered variables
[ Info: Created model
[ Info: Initialised filtered variables
[ Info: Defined outputs
[ Info: Defined simulation
[ Info: Initializing simulation...
[ Info: Simulation time: 0 seconds
[ Info:     ... simulation initialization complete (36.719 seconds)
[ Info: Executing initial time step...
[ Info:     ... initial time step complete (25.132 seconds).
[ Info: Simulation time: 7.200 hours
[ Info: Simulation time: 14.400 hours
[ Info: Simulation time: 21.600 hours
[ Info: Simulation time: 1.200 days
[ Info: Simulation time: 1.500 days
[ Info: Simulation time: 1.800 days
[ Info: Simulation time: 2.100 days
[ Info: Simulation time: 2.400 days
[ Info: Simulation time: 2.700 days
[ Info: Simulation is stopping after running for 14.392 minutes.
[ Info: Simulation time 3 days equals or exceeds stop time 3 days.
[ Info: Simulation time: 3 days
[ Info: Initializing simulation...
[ Info: Simulation time: 0 seconds
[ Info:     ... simulation initialization complete (1.275 seconds)
[ Info: Executing initial time step...
[ Info:     ... initial time step complete (4.853 seconds).
[ Info: Simulation time: 7.200 hours
[ Info: Simulation time: 14.400 hours
[ Info: Simulation time: 21.600 hours
[ Info: Simulation time: 1.200 days
[ Info: Simulation time: 1.500 days
[ Info: Simulation time: 1.800 days
[ Info: Simulation time: 2.100 days
[ Info: Simulation time: 2.400 days
[ Info: Simulation time: 2.700 days
[ Info: Simulation is stopping after running for 13.580 minutes.
[ Info: Simulation time 3 days equals or exceeds stop time 3 days.
[ Info: Simulation time: 3 days
[ Info: Combined forward and backward contributions into geostrophic_adjustment_offline_filtered.jld2
[ Info: Assuming velocities normal to z boundaries are zero
[ Info: Wrote regridded data to new variables with _at_mean suffix in file geostrophic_adjustment_offline_filtered.jld2
[ Info: Computing Eulerian filter for variable T
[ Info: Computing Eulerian filter for variable b
[ Info: Computing Eulerian filter for variable u
[ Info: Computing Eulerian filter for variable w
[ Info: Computing Eulerian filter for variable v
[ Info: Wrote NetCDF file to geostrophic_adjustment_offline_filtered.nc
</code></pre><h3 id="Visualisation"><a class="docs-heading-anchor" href="#Visualisation">Visualisation</a><a id="Visualisation-1"></a><a class="docs-heading-anchor-permalink" href="#Visualisation" title="Permalink"></a></h3><pre><code class="language-julia hljs">using CairoMakie</code></pre><p>Now we animate the results. First, the buoyancy:</p><pre><code class="language-julia hljs">timeseries1 = FieldTimeSeries(filter_config.output_filename, &quot;b&quot;)
timeseries2 = FieldTimeSeries(filter_config.output_filename, &quot;b_Eulerian_filtered&quot;)
timeseries3 = FieldTimeSeries(filter_config.output_filename, &quot;b_Lagrangian_filtered&quot;)
timeseries4 = FieldTimeSeries(filter_config.output_filename, &quot;b_Lagrangian_filtered_at_mean&quot;)

times = timeseries1.times

set_theme!(Theme(fontsize = 20))
fig = Figure(size = (1300, 500))

axis_kwargs = (xlabel = &quot;x&quot;,
               ylabel = &quot;z&quot;,
               limits = ((-5000, 5000), (-100, 0)),
               aspect = AxisAspect(1))

ax1 = Axis(fig[2, 1]; title = &quot;Raw&quot;, axis_kwargs...)
ax2 = Axis(fig[2, 2]; title = &quot;Eulerian filtered&quot;, axis_kwargs...)
ax3 = Axis(fig[2, 3]; title = &quot;Lagrangian filtered&quot;, axis_kwargs...)
ax4 = Axis(fig[2, 4]; title = &quot;Lagrangian filtered at mean&quot;, axis_kwargs...)


n = Observable(1)
Observable(1)

var1 = @lift timeseries1[$n]
var2 = @lift timeseries2[$n]
var3 = @lift timeseries3[$n]
var4 = @lift timeseries4[$n]

heatmap!(ax1, var1; colormap = :balance, colorrange = (-1e-4, 1e-4))
heatmap!(ax2, var2; colormap = :balance, colorrange = (-1e-4, 1e-4))
heatmap!(ax3, var3; colormap = :balance, colorrange = (-1e-4, 1e-4))
heatmap!(ax4, var4; colormap = :balance, colorrange = (-1e-4, 1e-4))


title = @lift &quot;Buoyancy, time = &quot; * string(round(times[$n]./3600., digits=2)) * &quot; hours&quot;
Label(fig[1, 1:4], title, fontsize=24, tellwidth=false)

fig

frames = 1:length(times)

@info &quot;Making an animation&quot;

CairoMakie.record(fig, &quot;geostrophic_adjustment_filtered_buoyancy_movie_offline.mp4&quot;, frames, framerate=24) do i
    n[] = i
end</code></pre><pre><code class="nohighlight hljs">&quot;geostrophic_adjustment_filtered_buoyancy_movie_offline.mp4&quot;</code></pre><p><video src="../geostrophic_adjustment_filtered_buoyancy_movie_offline.mp4" controls="true" title><a href="../geostrophic_adjustment_filtered_buoyancy_movie_offline.mp4"></a></video></p><p>Then the tracer:</p><pre><code class="language-julia hljs">timeseries1 = FieldTimeSeries(filter_config.output_filename, &quot;T&quot;)
timeseries2 = FieldTimeSeries(filter_config.output_filename, &quot;T_Eulerian_filtered&quot;)
timeseries3 = FieldTimeSeries(filter_config.output_filename, &quot;T_Lagrangian_filtered&quot;)
timeseries4 = FieldTimeSeries(filter_config.output_filename, &quot;T_Lagrangian_filtered_at_mean&quot;)

times = timeseries1.times

set_theme!(Theme(fontsize = 20))
fig = Figure(size = (1300, 500))

axis_kwargs = (xlabel = &quot;x&quot;,
               ylabel = &quot;z&quot;,
               limits = ((-5000, 5000), (-100, 0)),
               aspect = AxisAspect(1))

ax1 = Axis(fig[2, 1]; title = &quot;Raw&quot;, axis_kwargs...)
ax2 = Axis(fig[2, 2]; title = &quot;Eulerian filtered&quot;, axis_kwargs...)
ax3 = Axis(fig[2, 3]; title = &quot;Lagrangian filtered&quot;, axis_kwargs...)
ax4 = Axis(fig[2, 4]; title = &quot;Lagrangian filtered \n at mean position&quot;, axis_kwargs...)


n = Observable(1)
Observable(1)

var1 = @lift timeseries1[$n]
var2 = @lift timeseries2[$n]
var3 = @lift timeseries3[$n]
var4 = @lift timeseries4[$n]

heatmap!(ax1, var1; colormap = :Spectral, colorrange = (0, 1))
heatmap!(ax2, var2; colormap = :Spectral, colorrange = (0, 1))
heatmap!(ax3, var3; colormap = :Spectral, colorrange = (0, 1))
heatmap!(ax4, var4; colormap = :Spectral, colorrange = (0, 1))


title = @lift &quot;Tracer concentration, time = &quot; * string(round(times[$n]./3600., digits=2)) * &quot; hours&quot;
Label(fig[1, 1:4], title, fontsize=24, tellwidth=false)

fig

frames = 1:length(times)

@info &quot;Making an animation&quot;

CairoMakie.record(fig, &quot;geostrophic_adjustment_filtered_tracer_movie_offline.mp4&quot;, frames, framerate=24) do i
    n[] = i
end</code></pre><pre><code class="nohighlight hljs">&quot;geostrophic_adjustment_filtered_tracer_movie_offline.mp4&quot;</code></pre><p><video src="../geostrophic_adjustment_filtered_tracer_movie_offline.mp4" controls="true" title><a href="../geostrophic_adjustment_filtered_tracer_movie_offline.mp4"></a></video></p><p>We see that the Eulerian filter smudges the tracer field as it is advected by the inertial oscillations. The Lagrangian means directly calculated by this method are identical to the raw fields for the tracer and buoyancy shown, as they are conservative fields. However, when we remap to a mean reference position, we see the value of the Lagrangian filter in effectively removing the oscillations while preserving the tracer structures.</p><p>Then the velocity into the page, v:</p><pre><code class="language-julia hljs">timeseries1 = FieldTimeSeries(filter_config.output_filename, &quot;v&quot;)
timeseries2 = FieldTimeSeries(filter_config.output_filename, &quot;v_Eulerian_filtered&quot;)
timeseries3 = FieldTimeSeries(filter_config.output_filename, &quot;v_Lagrangian_filtered&quot;)
timeseries4 = FieldTimeSeries(filter_config.output_filename, &quot;v_Lagrangian_filtered_at_mean&quot;)

times = timeseries1.times

set_theme!(Theme(fontsize = 20))
fig = Figure(size = (1300, 500))

axis_kwargs = (xlabel = &quot;x&quot;,
               ylabel = &quot;z&quot;,
               limits = ((-5000, 5000), (-100, 0)),
               aspect = AxisAspect(1))

ax1 = Axis(fig[2, 1]; title = &quot;Raw&quot;, axis_kwargs...)
ax2 = Axis(fig[2, 2]; title = &quot;Eulerian filtered&quot;, axis_kwargs...)
ax3 = Axis(fig[2, 3]; title = &quot;Lagrangian filtered&quot;, axis_kwargs...)
ax4 = Axis(fig[2, 4]; title = &quot;Lagrangian filtered \n at mean position&quot;, axis_kwargs...)


n = Observable(1)
Observable(1)

var1 = @lift timeseries1[$n]
var2 = @lift timeseries2[$n]
var3 = @lift timeseries3[$n]
var4 = @lift timeseries4[$n]

heatmap!(ax1, var1; colormap = :balance, colorrange = (-0.05, 0.05))
heatmap!(ax2, var2; colormap = :balance, colorrange = (-0.05, 0.05))
heatmap!(ax3, var3; colormap = :balance, colorrange = (-0.05, 0.05))
heatmap!(ax4, var4; colormap = :balance, colorrange = (-0.05, 0.05))


title = @lift &quot;Velocity v, time = &quot; * string(round(times[$n]./3600., digits=2)) * &quot; hours&quot;
Label(fig[1, 1:4], title, fontsize=24, tellwidth=false)

fig

frames = 1:length(times)

@info &quot;Making an animation&quot;

CairoMakie.record(fig, &quot;geostrophic_adjustment_filtered_v_movie_offline.mp4&quot;, frames, framerate=24) do i
    n[] = i
end</code></pre><pre><code class="nohighlight hljs">&quot;geostrophic_adjustment_filtered_v_movie_offline.mp4&quot;</code></pre><p><video src="../geostrophic_adjustment_filtered_v_movie_offline.mp4" controls="true" title><a href="../geostrophic_adjustment_filtered_v_movie_offline.mp4"></a></video></p><p>In this case, the Lagrangian filtered velocity fields differ from the raw fields, as expected, since velocity is not a conservative field.</p><p>We remove these files to keep things tidy, keep them for analysis if desired</p><pre><code class="language-julia hljs">rm(filename_stem * &quot;.jld2&quot;)
rm(filter_config.output_filename)
rm(filter_config.output_filename[1:end-5] * &quot;.nc&quot;)</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../online_filter_geostrophic_adjustment/">« Geostrophic adjustment online</a><a class="docs-footer-nextpage" href="../offline_filter_shallow_water_IO/">Shallow water inertial oscillation offline »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.15.0 on <span class="colophon-date" title="Wednesday 29 October 2025 18:24">Wednesday 29 October 2025</span>. Using Julia version 1.10.10.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
