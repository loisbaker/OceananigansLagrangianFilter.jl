<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Geostrophic adjustment online · OceananigansLagrangianFilter.jl</title><meta name="title" content="Geostrophic adjustment online · OceananigansLagrangianFilter.jl"/><meta property="og:title" content="Geostrophic adjustment online · OceananigansLagrangianFilter.jl"/><meta property="twitter:title" content="Geostrophic adjustment online · OceananigansLagrangianFilter.jl"/><meta name="description" content="Documentation for OceananigansLagrangianFilter.jl."/><meta property="og:description" content="Documentation for OceananigansLagrangianFilter.jl."/><meta property="twitter:description" content="Documentation for OceananigansLagrangianFilter.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">OceananigansLagrangianFilter.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../installation/">Installation</a></li><li><a class="tocitem" href="../../quick_start/">Quick start</a></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">Theory</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../theory/Eulerian_Lagrangian_definitions/">Eulerian and Lagrangian averaging</a></li><li><a class="tocitem" href="../../theory/filtering_PDEs/">Background: PDEs for Lagrangian filtering</a></li><li><a class="tocitem" href="../../theory/online_equations/">Online Lagrangian filtering equations</a></li><li><a class="tocitem" href="../../theory/offline_equations/">Offline Lagrangian filtering equations</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">Online filtering</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../online_filtering/online_implementation/">Online filtering implementation</a></li><li><a class="tocitem" href="../../online_filtering/choosing_online_filters/">Choosing online filters</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">Offline filtering</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../offline_filtering/offline_implementation/">Offline filtering implementation</a></li><li><a class="tocitem" href="../../offline_filtering/choosing_offline_filters/">Choosing offline filters</a></li><li><a class="tocitem" href="../../offline_filtering/offline_how_it_works/">How it works</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox" checked/><label class="tocitem" for="menuitem-7"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Geostrophic adjustment online</a></li><li><a class="tocitem" href="../offline_filter_geostrophic_adjustment/">Geostrophic adjustment offline</a></li><li><a class="tocitem" href="../offline_filter_shallow_water_IO/">Shallow water inertial oscillation offline</a></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li><li><a class="tocitem" href="../../library/">Library</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Geostrophic adjustment online</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Geostrophic adjustment online</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://loisbaker.github.io/OceananigansLagrangianFilter.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Geostrophic-adjustment-with-online-Lagrangian-filtering"><a class="docs-heading-anchor" href="#Geostrophic-adjustment-with-online-Lagrangian-filtering">Geostrophic adjustment with online Lagrangian filtering</a><a id="Geostrophic-adjustment-with-online-Lagrangian-filtering-1"></a><a class="docs-heading-anchor-permalink" href="#Geostrophic-adjustment-with-online-Lagrangian-filtering" title="Permalink"></a></h1><p>We set up a geostrophic adjustment problem similar to Blumen (2000), <em>JPO</em> in a domain that is horizontally periodic.</p><p>An initially unbalanced two-dimensional front oscillates with the inertial frequency around a state of geostrophic balance, and we illustrate that we can remove the oscillations to find the mean state. Thanks to Tom Cummings for work on this example.</p><p>In this example, the filtering is performed online during the simulation.</p><h3 id="Load-dependencies"><a class="docs-heading-anchor" href="#Load-dependencies">Load dependencies</a><a id="Load-dependencies-1"></a><a class="docs-heading-anchor-permalink" href="#Load-dependencies" title="Permalink"></a></h3><pre><code class="language-julia hljs">using OceananigansLagrangianFilter # Gives access to all Oceananigans functions too
using Oceananigans.Units
using NCDatasets
using Printf</code></pre><h3 id="Model-parameters"><a class="docs-heading-anchor" href="#Model-parameters">Model parameters</a><a id="Model-parameters-1"></a><a class="docs-heading-anchor-permalink" href="#Model-parameters" title="Permalink"></a></h3><pre><code class="language-julia hljs">Nx = 400
Nz = 80
f = 1e-4                # Coriolis frequency [s⁻¹]
L_front = 10kilometers  # Initial front width [m]
aspect_ratio = 100      # L_front/H
Ro = 0.1                # Rossby number (defines M^2)


H = L_front/aspect_ratio  # Depth
M² = (Ro^2*f^2*L_front)/H # Horizontal buoyancy gradient
Δb = M²*L_front # Buoyancy difference across the front
κh = 1e-6 # Horizontal diffusivity
κv = 1e-6 # Vertical diffusivity

filename_stem = &quot;geostrophic_adjustment_online_filtered&quot;;</code></pre><h3 id="Grid"><a class="docs-heading-anchor" href="#Grid">Grid</a><a id="Grid-1"></a><a class="docs-heading-anchor-permalink" href="#Grid" title="Permalink"></a></h3><pre><code class="language-julia hljs">grid = RectilinearGrid(CPU(),size = (Nx, Nz),
                       x = (-L_front/2, L_front/2),
                       z = (-H, 0),
                       topology = (Periodic, Flat, Bounded))</code></pre><pre><code class="nohighlight hljs">400×1×80 RectilinearGrid{Float64, Periodic, Flat, Bounded} on CPU with 3×0×3 halo
├── Periodic x ∈ [-5000.0, 5000.0) regularly spaced with Δx=25.0
├── Flat y                         
└── Bounded  z ∈ [-100.0, 0.0]     regularly spaced with Δz=1.25</code></pre><h3 id="Define-model-tracers"><a class="docs-heading-anchor" href="#Define-model-tracers">Define model tracers</a><a id="Define-model-tracers-1"></a><a class="docs-heading-anchor-permalink" href="#Define-model-tracers" title="Permalink"></a></h3><pre><code class="language-julia hljs">tracers = (:b,:T);</code></pre><h3 id="Define-model-forcing"><a class="docs-heading-anchor" href="#Define-model-forcing">Define model forcing</a><a id="Define-model-forcing-1"></a><a class="docs-heading-anchor-permalink" href="#Define-model-forcing" title="Permalink"></a></h3><pre><code class="language-julia hljs">forcing = NamedTuple();</code></pre><h3 id="Define-filter-configuration"><a class="docs-heading-anchor" href="#Define-filter-configuration">Define filter configuration</a><a id="Define-filter-configuration-1"></a><a class="docs-heading-anchor-permalink" href="#Define-filter-configuration" title="Permalink"></a></h3><pre><code class="language-julia hljs">filter_config = OnlineFilterConfig( grid = grid,
                                    output_filename = filename_stem * &quot;.jld2&quot;,
                                    var_names_to_filter = (&quot;b&quot;,&quot;T&quot;),
                                    velocity_names = (&quot;u&quot;,&quot;w&quot;,&quot;v&quot;),
                                    N = 2,
                                    freq_c = f/2)</code></pre><pre><code class="nohighlight hljs">OnlineFilterConfig(400×1×80 RectilinearGrid{Float64, Periodic, Flat, Bounded} on CPU with 3×0×3 halo
├── Periodic x ∈ [-5000.0, 5000.0) regularly spaced with Δx=25.0
├── Flat y                         
└── Bounded  z ∈ [-100.0, 0.0]     regularly spaced with Δz=1.25, &quot;geostrophic_adjustment_online_filtered.jld2&quot;, (&quot;b&quot;, &quot;T&quot;), (&quot;u&quot;, &quot;w&quot;, &quot;v&quot;), (a1 = 1.421067568548072e-20, b1 = -7.071067811865475e-5, c1 = 3.535533905932738e-5, d1 = -3.535533905932738e-5, N_coeffs = 1), true, true, 5, &quot;online&quot;)</code></pre><h3 id="Create-the-filtered-variables-these-will-be-tracers-in-the-model"><a class="docs-heading-anchor" href="#Create-the-filtered-variables-these-will-be-tracers-in-the-model">Create the filtered variables - these will be tracers in the model</a><a id="Create-the-filtered-variables-these-will-be-tracers-in-the-model-1"></a><a class="docs-heading-anchor-permalink" href="#Create-the-filtered-variables-these-will-be-tracers-in-the-model" title="Permalink"></a></h3><pre><code class="language-julia hljs">filtered_vars = create_filtered_vars(filter_config)</code></pre><pre><code class="nohighlight hljs">(:b_C1, :T_C1, :xi_u_C1, :xi_w_C1, :xi_v_C1, :b_S1, :T_S1, :xi_u_S1, :xi_w_S1, :xi_v_S1)</code></pre><h3 id="Add-to-the-existing-tracers"><a class="docs-heading-anchor" href="#Add-to-the-existing-tracers">Add to the existing tracers</a><a id="Add-to-the-existing-tracers-1"></a><a class="docs-heading-anchor-permalink" href="#Add-to-the-existing-tracers" title="Permalink"></a></h3><pre><code class="language-julia hljs">tracers = (filtered_vars..., tracers...)</code></pre><pre><code class="nohighlight hljs">(:b_C1, :T_C1, :xi_u_C1, :xi_w_C1, :xi_v_C1, :b_S1, :T_S1, :xi_u_S1, :xi_w_S1, :xi_v_S1, :b, :T)</code></pre><h3 id="Create-forcing-for-these-filtered-variables"><a class="docs-heading-anchor" href="#Create-forcing-for-these-filtered-variables">Create forcing for these filtered variables</a><a id="Create-forcing-for-these-filtered-variables-1"></a><a class="docs-heading-anchor-permalink" href="#Create-forcing-for-these-filtered-variables" title="Permalink"></a></h3><pre><code class="language-julia hljs">filter_forcing = create_forcing(filtered_vars, filter_config);</code></pre><h3 id="Add-these-to-the-existing-forcing"><a class="docs-heading-anchor" href="#Add-these-to-the-existing-forcing">Add these to the existing forcing</a><a id="Add-these-to-the-existing-forcing-1"></a><a class="docs-heading-anchor-permalink" href="#Add-these-to-the-existing-forcing" title="Permalink"></a></h3><pre><code class="language-julia hljs">forcing = merge(forcing, filter_forcing);</code></pre><h3 id="Define-closures"><a class="docs-heading-anchor" href="#Define-closures">Define closures</a><a id="Define-closures-1"></a><a class="docs-heading-anchor-permalink" href="#Define-closures" title="Permalink"></a></h3><p>If the model uses a closure, we use a helper function to set filtered variable closures to zero (unless we set filtered variable closures to zero, the default closure will apply to all tracers).</p><pre><code class="language-julia hljs">zero_filtered_var_closure = zero_closure_for_filtered_vars(filter_config)
horizontal_closure = HorizontalScalarDiffusivity(ν=κh, κ=merge((T=κh, b= κh),zero_filtered_var_closure) )
vertical_closure = VerticalScalarDiffusivity(ν=κv , κ=merge((T=κv, b= κv),zero_filtered_var_closure) )
closure = (horizontal_closure, vertical_closure);</code></pre><h3 id="Define-the-model"><a class="docs-heading-anchor" href="#Define-the-model">Define the model</a><a id="Define-the-model-1"></a><a class="docs-heading-anchor-permalink" href="#Define-the-model" title="Permalink"></a></h3><pre><code class="language-julia hljs">model =  NonhydrostaticModel(; grid,
                coriolis = FPlane(f = f),
                buoyancy = BuoyancyTracer(),
                tracers = tracers,
                forcing = forcing,
                advection = WENO(),
                closure = closure)</code></pre><pre><code class="nohighlight hljs">NonhydrostaticModel{CPU, RectilinearGrid}(time = 0 seconds, iteration = 0)
├── grid: 400×1×80 RectilinearGrid{Float64, Periodic, Flat, Bounded} on CPU with 3×0×3 halo
├── timestepper: RungeKutta3TimeStepper
├── advection scheme: WENO{3, Float64, Float32}(order=5)
├── tracers: (b_C1, T_C1, xi_u_C1, xi_w_C1, xi_v_C1, b_S1, T_S1, xi_u_S1, xi_w_S1, xi_v_S1, b, T)
├── closure: Tuple with 2 closures:
│   ├── HorizontalScalarDiffusivity{ExplicitTimeDiscretization}(ν=1.0e-6, κ=(b_C1=0.0, T_C1=0.0, xi_u_C1=0.0, xi_w_C1=0.0, xi_v_C1=0.0, b_S1=0.0, T_S1=0.0, xi_u_S1=0.0, xi_w_S1=0.0, xi_v_S1=0.0, b=1.0e-6, T=1.0e-6))
│   └── VerticalScalarDiffusivity{ExplicitTimeDiscretization}(ν=1.0e-6, κ=(b_C1=0.0, T_C1=0.0, xi_u_C1=0.0, xi_w_C1=0.0, xi_v_C1=0.0, b_S1=0.0, T_S1=0.0, xi_u_S1=0.0, xi_w_S1=0.0, xi_v_S1=0.0, b=1.0e-6, T=1.0e-6))
├── buoyancy: BuoyancyTracer with ĝ = NegativeZDirection()
└── coriolis: FPlane{Float64}(f=0.0001)</code></pre><h3 id="Initialise-tracers"><a class="docs-heading-anchor" href="#Initialise-tracers">Initialise tracers</a><a id="Initialise-tracers-1"></a><a class="docs-heading-anchor-permalink" href="#Initialise-tracers" title="Permalink"></a></h3><p>Model buoyancy and tracers</p><pre><code class="language-julia hljs">bᵢ(x, z) = Δb*sin(2*pi/L_front * x)
Tᵢ(x, z) = exp(-(x/(L_front/50)).^2)
set!(model, b= bᵢ, T= Tᵢ)</code></pre><p>Set appropriate initial conditions for the filtered variables based on the actual variables</p><pre><code class="language-julia hljs">initialise_filtered_vars_from_model(model, filter_config)</code></pre><h3 id="Define-the-simulation"><a class="docs-heading-anchor" href="#Define-the-simulation">Define the simulation</a><a id="Define-the-simulation-1"></a><a class="docs-heading-anchor-permalink" href="#Define-the-simulation" title="Permalink"></a></h3><pre><code class="language-julia hljs">simulation = Simulation(model, Δt=20minutes, stop_time=3days)</code></pre><pre><code class="nohighlight hljs">Simulation of NonhydrostaticModel{CPU, RectilinearGrid}(time = 0 seconds, iteration = 0)
├── Next time step: 20 minutes
├── Elapsed wall time: 0 seconds
├── Wall time per iteration: NaN days
├── Stop time: 3 days
├── Stop iteration: Inf
├── Wall time limit: Inf
├── Minimum relative step: 0.0
├── Callbacks: OrderedDict with 4 entries:
│   ├── stop_time_exceeded =&gt; 4
│   ├── stop_iteration_exceeded =&gt; -
│   ├── wall_time_limit_exceeded =&gt; e
│   └── nan_checker =&gt; }
├── Output writers: OrderedDict with no entries
└── Diagnostics: OrderedDict with no entries</code></pre><h3 id="Set-an-adaptive-timestep"><a class="docs-heading-anchor" href="#Set-an-adaptive-timestep">Set an adaptive timestep</a><a id="Set-an-adaptive-timestep-1"></a><a class="docs-heading-anchor-permalink" href="#Set-an-adaptive-timestep" title="Permalink"></a></h3><pre><code class="language-julia hljs">conjure_time_step_wizard!(simulation, IterationInterval(20), cfl=0.2, max_Δt=20minutes)</code></pre><h3 id="Add-a-progress-callback"><a class="docs-heading-anchor" href="#Add-a-progress-callback">Add a progress callback</a><a id="Add-a-progress-callback-1"></a><a class="docs-heading-anchor-permalink" href="#Add-a-progress-callback" title="Permalink"></a></h3><pre><code class="language-julia hljs">wall_clock = Ref(time_ns())

function print_progress(sim)
    u, v, w = model.velocities
    progress = 100 * (time(sim) / sim.stop_time)
    elapsed = (time_ns() - wall_clock[]) / 1e9

    @printf(&quot;[%05.2f%%] i: %d, t: %s, wall time: %s, max(u): (%6.3e, %6.3e, %6.3e) m/s, next Δt: %s\n&quot;,
            progress, iteration(sim), prettytime(sim), prettytime(elapsed),
            maximum(abs, u), maximum(abs, v), maximum(abs, w), prettytime(sim.Δt))

    wall_clock[] = time_ns()

    return nothing
end

add_callback!(simulation, print_progress, IterationInterval(50))</code></pre><h3 id="Set-up-the-outputs"><a class="docs-heading-anchor" href="#Set-up-the-outputs">Set up the outputs</a><a id="Set-up-the-outputs-1"></a><a class="docs-heading-anchor-permalink" href="#Set-up-the-outputs" title="Permalink"></a></h3><p>Create filtered outputs:</p><pre><code class="language-julia hljs">outputs = create_output_fields(model, filter_config);</code></pre><p>Add in original variables if needed:</p><pre><code class="language-julia hljs">outputs[&quot;b&quot;] = model.tracers.b;
outputs[&quot;T&quot;] = model.tracers.T;
outputs[&quot;u&quot;] = model.velocities.u;
outputs[&quot;v&quot;] = model.velocities.v;
outputs[&quot;w&quot;] = model.velocities.w;</code></pre><p>Output a .jld2 file:</p><pre><code class="language-julia hljs">simulation.output_writers[:jld2fields] = JLD2Writer(
    model, outputs, filename=filter_config.output_filename, schedule=TimeInterval(1hour), overwrite_existing=true)</code></pre><pre><code class="nohighlight hljs">JLD2Writer scheduled on TimeInterval(1 hour):
├── filepath: geostrophic_adjustment_online_filtered.jld2
├── 13 outputs: (xi_u, T, b, b_Lagrangian_filtered, xi_v, xi_w, v, w, v_Lagrangian_filtered, w_Lagrangian_filtered, T_Lagrangian_filtered, u, u_Lagrangian_filtered)
├── array_type: Array{Float32}
├── including: [:grid, :coriolis, :buoyancy, :closure]
├── file_splitting: NoFileSplitting
└── file size: 92.7 KiB</code></pre><h3 id="Run-the-simulation"><a class="docs-heading-anchor" href="#Run-the-simulation">Run the simulation</a><a id="Run-the-simulation-1"></a><a class="docs-heading-anchor-permalink" href="#Run-the-simulation" title="Permalink"></a></h3><pre><code class="language-julia hljs">@info &quot;Running the simulation...&quot;

run!(simulation)

@info &quot;Simulation completed in &quot; * prettytime(simulation.run_wall_time)</code></pre><pre><code class="nohighlight hljs">[ Info: Running the simulation...
[ Info: Initializing simulation...
[00.00%] i: 0, t: 0 seconds, wall time: 6.655 minutes, max(u): (0.000e+00, 0.000e+00, 0.000e+00) m/s, next Δt: 20 minutes
[ Info:     ... simulation initialization complete (43.220 seconds)
[ Info: Executing initial time step...
[ Info:     ... initial time step complete (17.657 seconds).
[15.28%] i: 50, t: 11 hours, wall time: 2.990 minutes, max(u): (2.202e-02, 5.270e-02, 3.914e-04) m/s, next Δt: 6.203 minutes
[19.31%] i: 100, t: 13.906 hours, wall time: 2.602 minutes, max(u): (2.976e-02, 2.367e-02, 5.020e-04) m/s, next Δt: 2.799 minutes
[22.61%] i: 150, t: 16.282 hours, wall time: 2.611 minutes, max(u): (1.443e-02, 3.788e-03, 1.988e-04) m/s, next Δt: 3.387 minutes
[26.86%] i: 200, t: 19.342 hours, wall time: 2.601 minutes, max(u): (1.883e-02, 6.605e-03, 3.550e-04) m/s, next Δt: 4.424 minutes
[30.87%] i: 250, t: 22.226 hours, wall time: 2.594 minutes, max(u): (3.045e-02, 3.460e-02, 5.432e-04) m/s, next Δt: 2.715 minutes
[34.20%] i: 300, t: 1.026 days, wall time: 2.569 minutes, max(u): (1.758e-02, 5.627e-02, 3.551e-04) m/s, next Δt: 3.427 minutes
[38.36%] i: 350, t: 1.151 days, wall time: 2.558 minutes, max(u): (1.557e-02, 5.846e-02, 3.039e-04) m/s, next Δt: 4.146 minutes
[42.42%] i: 400, t: 1.272 days, wall time: 2.604 minutes, max(u): (3.047e-02, 3.393e-02, 6.365e-04) m/s, next Δt: 2.734 minutes
[45.61%] i: 450, t: 1.368 days, wall time: 2.595 minutes, max(u): (2.293e-02, 1.084e-02, 3.965e-04) m/s, next Δt: 3.087 minutes
[49.48%] i: 500, t: 1.484 days, wall time: 2.595 minutes, max(u): (9.185e-03, 3.523e-03, 2.614e-04) m/s, next Δt: 4.108 minutes
[53.85%] i: 550, t: 1.616 days, wall time: 2.600 minutes, max(u): (2.970e-02, 2.389e-02, 6.375e-04) m/s, next Δt: 2.974 minutes
[57.01%] i: 600, t: 1.710 days, wall time: 2.611 minutes, max(u): (2.567e-02, 4.759e-02, 5.999e-04) m/s, next Δt: 3.103 minutes
[60.83%] i: 650, t: 1.825 days, wall time: 2.582 minutes, max(u): (5.828e-03, 6.138e-02, 1.666e-04) m/s, next Δt: 3.754 minutes
[65.28%] i: 700, t: 1.958 days, wall time: 2.567 minutes, max(u): (2.768e-02, 4.460e-02, 7.864e-04) m/s, next Δt: 3.010 minutes
[68.58%] i: 750, t: 2.057 days, wall time: 2.597 minutes, max(u): (2.803e-02, 1.974e-02, 6.938e-04) m/s, next Δt: 2.826 minutes
[72.18%] i: 800, t: 2.165 days, wall time: 2.593 minutes, max(u): (9.144e-03, 5.733e-03, 1.370e-04) m/s, next Δt: 3.761 minutes
[76.67%] i: 850, t: 2.300 days, wall time: 2.596 minutes, max(u): (2.459e-02, 1.281e-02, 7.403e-04) m/s, next Δt: 4.111 minutes
[80.19%] i: 900, t: 2.406 days, wall time: 2.609 minutes, max(u): (2.915e-02, 3.900e-02, 8.372e-04) m/s, next Δt: 2.859 minutes
[83.65%] i: 950, t: 2.510 days, wall time: 2.613 minutes, max(u): (1.226e-02, 5.871e-02, 5.816e-04) m/s, next Δt: 3.459 minutes
[87.98%] i: 1000, t: 2.640 days, wall time: 2.615 minutes, max(u): (2.078e-02, 5.400e-02, 7.878e-04) m/s, next Δt: 4.009 minutes
[91.73%] i: 1050, t: 2.752 days, wall time: 2.594 minutes, max(u): (2.994e-02, 2.808e-02, 1.101e-03) m/s, next Δt: 2.773 minutes
[95.03%] i: 1100, t: 2.851 days, wall time: 2.616 minutes, max(u): (1.746e-02, 7.973e-03, 4.233e-04) m/s, next Δt: 3.472 minutes
[99.19%] i: 1150, t: 2.976 days, wall time: 2.630 minutes, max(u): (1.506e-02, 8.607e-03, 7.962e-04) m/s, next Δt: 4.202 minutes
[ Info: Simulation is stopping after running for 1.019 hours.
[ Info: Simulation time 3 days equals or exceeds stop time 3 days.
[ Info: Simulation completed in 1.020 hours
</code></pre><h3 id="Option-to-regrid-to-mean-position"><a class="docs-heading-anchor" href="#Option-to-regrid-to-mean-position">Option to regrid to mean position</a><a id="Option-to-regrid-to-mean-position-1"></a><a class="docs-heading-anchor-permalink" href="#Option-to-regrid-to-mean-position" title="Permalink"></a></h3><pre><code class="language-julia hljs">if filter_config.map_to_mean
    regrid_to_mean_position!(filter_config)
end</code></pre><pre><code class="nohighlight hljs">[ Info: Assuming velocities normal to z boundaries are zero
[ Info: Wrote regridded data to new variables with _at_mean suffix in file geostrophic_adjustment_online_filtered.jld2
</code></pre><h3 id="Option-to-calculate-Eulerian-filter-too"><a class="docs-heading-anchor" href="#Option-to-calculate-Eulerian-filter-too">Option to calculate Eulerian filter too</a><a id="Option-to-calculate-Eulerian-filter-too-1"></a><a class="docs-heading-anchor-permalink" href="#Option-to-calculate-Eulerian-filter-too" title="Permalink"></a></h3><pre><code class="language-julia hljs">compute_Eulerian_filter!(filter_config);</code></pre><pre><code class="nohighlight hljs">[ Info: Computing Eulerian filter for variable b
[ Info: Computing Eulerian filter for variable T
[ Info: Computing Eulerian filter for variable u
[ Info: Computing Eulerian filter for variable w
[ Info: Computing Eulerian filter for variable v
</code></pre><h3 id="Option-to-add-a-shifted-time-coordinate"><a class="docs-heading-anchor" href="#Option-to-add-a-shifted-time-coordinate">Option to add a shifted time coordinate</a><a id="Option-to-add-a-shifted-time-coordinate-1"></a><a class="docs-heading-anchor-permalink" href="#Option-to-add-a-shifted-time-coordinate" title="Permalink"></a></h3><pre><code class="language-julia hljs">compute_time_shift!(filter_config)</code></pre><pre><code class="nohighlight hljs">[ Info: Wrote time shift data to new group timeseries/t_shifted in file geostrophic_adjustment_online_filtered.jld2
</code></pre><h3 id="Option-to-output-a-final-NetCDF-file"><a class="docs-heading-anchor" href="#Option-to-output-a-final-NetCDF-file">Option to output a final NetCDF file</a><a id="Option-to-output-a-final-NetCDF-file-1"></a><a class="docs-heading-anchor-permalink" href="#Option-to-output-a-final-NetCDF-file" title="Permalink"></a></h3><pre><code class="language-julia hljs">jld2_to_netcdf(filename_stem * &quot;.jld2&quot;, filename_stem * &quot;.nc&quot;)</code></pre><pre><code class="nohighlight hljs">[ Info: Wrote NetCDF file to geostrophic_adjustment_online_filtered.nc
</code></pre><h3 id="Animate-the-results,-buoyancy-first:"><a class="docs-heading-anchor" href="#Animate-the-results,-buoyancy-first:">Animate the results, buoyancy first:</a><a id="Animate-the-results,-buoyancy-first:-1"></a><a class="docs-heading-anchor-permalink" href="#Animate-the-results,-buoyancy-first:" title="Permalink"></a></h3><pre><code class="language-julia hljs">using CairoMakie

timeseries1 = FieldTimeSeries(filter_config.output_filename, &quot;b&quot;)
timeseries2 = FieldTimeSeries(filter_config.output_filename, &quot;b_Eulerian_filtered&quot;)
timeseries3 = FieldTimeSeries(filter_config.output_filename, &quot;b_Lagrangian_filtered&quot;)
timeseries4 = FieldTimeSeries(filter_config.output_filename, &quot;b_Lagrangian_filtered_at_mean&quot;)

times = timeseries1.times

set_theme!(Theme(fontsize = 20))
fig = Figure(size = (1300, 500))

axis_kwargs = (xlabel = &quot;x&quot;,
               ylabel = &quot;z&quot;,
               limits = ((-5000, 5000), (-100, 0)),
               aspect = AxisAspect(1))

ax1 = Axis(fig[2, 1]; title = &quot;Raw&quot;, axis_kwargs...)
ax2 = Axis(fig[2, 2]; title = &quot;Eulerian filtered&quot;, axis_kwargs...)
ax3 = Axis(fig[2, 3]; title = &quot;Lagrangian filtered&quot;, axis_kwargs...)
ax4 = Axis(fig[2, 4]; title = &quot;Lagrangian filtered at mean&quot;, axis_kwargs...)


n = Observable(1)
Observable(1)

var1 = @lift timeseries1[$n]
var2 = @lift timeseries2[$n]
var3 = @lift timeseries3[$n]
var4 = @lift timeseries4[$n]

heatmap!(ax1, var1; colormap = :balance, colorrange = (-1e-4, 1e-4))
heatmap!(ax2, var2; colormap = :balance, colorrange = (-1e-4, 1e-4))
heatmap!(ax3, var3; colormap = :balance, colorrange = (-1e-4, 1e-4))
heatmap!(ax4, var4; colormap = :balance, colorrange = (-1e-4, 1e-4))


title = @lift &quot;Buoyancy, time = &quot; * string(round(times[$n]./3600., digits=2)) * &quot; hours&quot;
Label(fig[1, 1:4], title, fontsize=24, tellwidth=false)

fig

frames = 1:length(times)

@info &quot;Making an animation&quot;

CairoMakie.record(fig, &quot;geostrophic_adjustment_filtered_buoyancy_movie_online.mp4&quot;, frames, framerate=24) do i
    n[] = i
end</code></pre><pre><code class="nohighlight hljs">&quot;geostrophic_adjustment_filtered_buoyancy_movie_online.mp4&quot;</code></pre><p><video src="../geostrophic_adjustment_filtered_buoyancy_movie_online.mp4" controls="true" title><a href="../geostrophic_adjustment_filtered_buoyancy_movie_online.mp4"></a></video></p><h3 id="Then-plot-the-tracer-concentration:"><a class="docs-heading-anchor" href="#Then-plot-the-tracer-concentration:">Then plot the tracer concentration:</a><a id="Then-plot-the-tracer-concentration:-1"></a><a class="docs-heading-anchor-permalink" href="#Then-plot-the-tracer-concentration:" title="Permalink"></a></h3><pre><code class="language-julia hljs">timeseries1 = FieldTimeSeries(filter_config.output_filename, &quot;T&quot;)
timeseries2 = FieldTimeSeries(filter_config.output_filename, &quot;T_Eulerian_filtered&quot;)
timeseries3 = FieldTimeSeries(filter_config.output_filename, &quot;T_Lagrangian_filtered&quot;)
timeseries4 = FieldTimeSeries(filter_config.output_filename, &quot;T_Lagrangian_filtered_at_mean&quot;)

times = timeseries1.times

set_theme!(Theme(fontsize = 20))
fig = Figure(size = (1300, 500))

axis_kwargs = (xlabel = &quot;x&quot;,
               ylabel = &quot;z&quot;,
               limits = ((-5000, 5000), (-100, 0)),
               aspect = AxisAspect(1))

ax1 = Axis(fig[2, 1]; title = &quot;Raw&quot;, axis_kwargs...)
ax2 = Axis(fig[2, 2]; title = &quot;Eulerian filtered&quot;, axis_kwargs...)
ax3 = Axis(fig[2, 3]; title = &quot;Lagrangian filtered&quot;, axis_kwargs...)
ax4 = Axis(fig[2, 4]; title = &quot;Lagrangian filtered at mean&quot;, axis_kwargs...)


n = Observable(1)
Observable(1)

var1 = @lift timeseries1[$n]
var2 = @lift timeseries2[$n]
var3 = @lift timeseries3[$n]
var4 = @lift timeseries4[$n]

heatmap!(ax1, var1; colormap = :Spectral, colorrange = (0, 1))
heatmap!(ax2, var2; colormap = :Spectral, colorrange = (0, 1))
heatmap!(ax3, var3; colormap = :Spectral, colorrange = (0, 1))
heatmap!(ax4, var4; colormap = :Spectral, colorrange = (0, 1))


title = @lift &quot;Tracer concentration, time = &quot; * string(round(times[$n]./3600., digits=2)) * &quot; hours&quot;
Label(fig[1, 1:4], title, fontsize=24, tellwidth=false)

fig

frames = 1:length(times)

@info &quot;Making an animation&quot;

CairoMakie.record(fig, &quot;geostrophic_adjustment_filtered_tracer_movie_online.mp4&quot;, frames, framerate=24) do i
    n[] = i
end</code></pre><pre><code class="nohighlight hljs">[ Info: Making an animation
</code></pre><p><video src="../geostrophic_adjustment_filtered_tracer_movie_online.mp4" controls="true" title><a href="../geostrophic_adjustment_filtered_tracer_movie_online.mp4"></a></video></p><p>We see that the Eulerian filter smudges the tracer field as it is advected by the inertial oscillations. The Lagrangian means directly calculated by this method are identical to the raw fields for the tracer and buoyancy shown, as they are conservative fields. However, when we remap to a mean reference position, we see the value of the Lagrangian filter in effectively removing the oscillations while preserving the tracer structures. In comparison to the offline filtering example, the online filter does a slightly worse job removing the oscillations in the &#39;Lagrangian filtered at mean&#39; field, since the filter is a more optimal low-pass.</p><p>Then the velocity into the page, v:</p><pre><code class="language-julia hljs">timeseries1 = FieldTimeSeries(filter_config.output_filename, &quot;v&quot;)
timeseries2 = FieldTimeSeries(filter_config.output_filename, &quot;v_Eulerian_filtered&quot;)
timeseries3 = FieldTimeSeries(filter_config.output_filename, &quot;v_Lagrangian_filtered&quot;)
timeseries4 = FieldTimeSeries(filter_config.output_filename, &quot;v_Lagrangian_filtered_at_mean&quot;)

times = timeseries1.times

set_theme!(Theme(fontsize = 20))
fig = Figure(size = (1300, 500))

axis_kwargs = (xlabel = &quot;x&quot;,
               ylabel = &quot;z&quot;,
               limits = ((-5000, 5000), (-100, 0)),
               aspect = AxisAspect(1))

ax1 = Axis(fig[2, 1]; title = &quot;Raw&quot;, axis_kwargs...)
ax2 = Axis(fig[2, 2]; title = &quot;Eulerian filtered&quot;, axis_kwargs...)
ax3 = Axis(fig[2, 3]; title = &quot;Lagrangian filtered&quot;, axis_kwargs...)
ax4 = Axis(fig[2, 4]; title = &quot;Lagrangian filtered \n at mean position&quot;, axis_kwargs...)


n = Observable(1)
Observable(1)

var1 = @lift timeseries1[$n]
var2 = @lift timeseries2[$n]
var3 = @lift timeseries3[$n]
var4 = @lift timeseries4[$n]

heatmap!(ax1, var1; colormap = :balance, colorrange = (-0.05, 0.05))
heatmap!(ax2, var2; colormap = :balance, colorrange = (-0.05, 0.05))
heatmap!(ax3, var3; colormap = :balance, colorrange = (-0.05, 0.05))
heatmap!(ax4, var4; colormap = :balance, colorrange = (-0.05, 0.05))


title = @lift &quot;Velocity v, time = &quot; * string(round(times[$n]./3600., digits=2)) * &quot; hours&quot;
Label(fig[1, 1:4], title, fontsize=24, tellwidth=false)

fig

frames = 1:length(times)

@info &quot;Making an animation&quot;

CairoMakie.record(fig, &quot;geostrophic_adjustment_filtered_v_movie_online.mp4&quot;, frames, framerate=24) do i
    n[] = i
end</code></pre><pre><code class="nohighlight hljs">&quot;geostrophic_adjustment_filtered_v_movie_online.mp4&quot;</code></pre><p><video src="../geostrophic_adjustment_filtered_v_movie_online.mp4" controls="true" title><a href="../geostrophic_adjustment_filtered_v_movie_online.mp4"></a></video></p><p>In this case, the Lagrangian filtered velocity fields differ from the raw fields, as expected, since velocity is not a conservative field.</p><pre><code class="language-julia hljs"># We remove these files to keep things tidy, keep them for analysis if desired
rm(filename_stem * &quot;.jld2&quot;)
rm(filename_stem * &quot;.nc&quot;)</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../offline_filtering/offline_how_it_works/">« How it works</a><a class="docs-footer-nextpage" href="../offline_filter_geostrophic_adjustment/">Geostrophic adjustment offline »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.15.0 on <span class="colophon-date" title="Friday 31 October 2025 19:07">Friday 31 October 2025</span>. Using Julia version 1.10.10.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
